<!DOCTYPE html> <!-- This tells the browser this is an HTML5 document -->
<html lang="en"> <!-- This starts the HTML document and says it's in English -->
<head> <!-- This is the "head" section where we put information about the page -->
    <meta charset="UTF-8"> <!-- This tells the browser what characters to use (like letters, numbers, symbols) -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- This makes the page work well on phones and tablets -->
    <title>Technical Jargon: Word Cloud</title> <!-- This is the text that appears in the browser tab -->
    <!-- These next two lines load special tools from the internet that help us read Excel files and make word clouds -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script> <!-- This tool helps us read Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script> <!-- This tool helps us make pretty pictures and word clouds -->
    <style> <!-- This starts the CSS section where we style how the page looks -->
        /* Design Variables - Easy to change colors, sizes, and spacing */
        :root {
            --primary-color: #1a1a1a; /* Very dark gray for main text - high contrast */
            --secondary-color: #0066cc; /* Darker blue for buttons and accents - high contrast */
            --background-color: #f5f5f5; /* Light gray background */
            --card-background: #ffffff; /* White for cards and panels */
            --border-color: #cccccc; /* Medium gray for borders - more visible */
            --text-muted: #333333; /* Dark gray for secondary text - high contrast */
            --text-light: #666666; /* Medium gray for lighter text - still readable */
            --success-color: #006600; /* Dark green for success states - high contrast */
            --warning-color: #cc6600; /* Dark orange for warnings - high contrast */
            --danger-color: #cc0000; /* Dark red for errors - high contrast */
            --shadow: 0 2px 10px rgba(0,0,0,0.15); /* Stronger shadow for better definition */
            --border-radius: 8px; /* Rounded corners */
            --spacing-sm: 8px; /* Small spacing */
            --spacing-md: 16px; /* Medium spacing */
            --spacing-lg: 24px; /* Large spacing */
            --spacing-xl: 32px; /* Extra large spacing */
        }

        body { /* This styles the entire page body */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* This sets the font (the style of letters) */
            margin: 0; /* This removes any space around the edges of the page */
            padding: 0; /* This removes padding from the body */
            background: var(--background-color); /* This sets the background color using our variable */
            color: var(--primary-color); /* This sets the text color using our variable */
            line-height: 1.6; /* This makes text easier to read by adding space between lines */
        }

        .header { /* This styles the header section at the top */
            background: var(--card-background); /* This makes the header white */
            padding: var(--spacing-lg); /* This adds large spacing inside the header */
            box-shadow: var(--shadow); /* This adds a subtle shadow */
            border-bottom: 1px solid var(--border-color); /* This adds a light border at the bottom */
        }

        .header h1 { /* This styles the main title */
            margin: 0; /* This removes default margin */
            font-size: 2rem; /* This makes the title 2 times bigger than normal text */
            font-weight: 600; /* This makes the title text medium weight */
            color: var(--primary-color); /* This sets the title color */
        }

        .main-container { /* This creates the main layout container */
            display: flex; /* This makes the container use flexbox layout */
            min-height: calc(100vh - 80px); /* This makes the container take up most of the screen height */
            max-width: 1400px; /* This limits the maximum width */
            margin: 0 auto; /* This centers the container */
            gap: var(--spacing-lg); /* This adds space between the side panel and main area */
            padding: var(--spacing-lg); /* This adds padding around the container */
        }

        .side-panel { /* This styles the left side panel with controls */
            width: 300px; /* This sets the width of the side panel */
            background: var(--card-background); /* This makes the panel white */
            border-radius: var(--border-radius); /* This makes the corners rounded */
            box-shadow: var(--shadow); /* This adds a subtle shadow */
            padding: var(--spacing-lg); /* This adds large spacing inside the panel */
            height: fit-content; /* This makes the panel only as tall as its content */
        }

        .main-area { /* This styles the main area where the word cloud appears */
            flex: 1; /* This makes the main area take up the remaining space */
            background: var(--card-background); /* This makes the main area white */
            border-radius: var(--border-radius); /* This makes the corners rounded */
            box-shadow: var(--shadow); /* This adds a subtle shadow */
            padding: var(--spacing-lg); /* This adds large spacing inside the main area */
            min-height: 600px; /* This ensures the main area is at least 600 pixels tall */
        }

        .file-picker-section { /* This styles the file picker area */
            margin-bottom: var(--spacing-xl); /* This adds extra large spacing below the file picker */
        }

        .file-picker-section h3 { /* This styles the "File Input" heading */
            margin: 0 0 var(--spacing-md) 0; /* This removes top margin and adds medium spacing below */
            font-size: 1.1rem; /* This makes the heading slightly bigger than normal text */
            color: var(--primary-color); /* This sets the heading color */
        }

        .file-input-wrapper { /* This styles the file input area */
            border: 2px dashed var(--secondary-color); /* This creates a blue dashed border */
            border-radius: var(--border-radius); /* This makes the corners rounded */
            padding: var(--spacing-lg); /* This adds large spacing inside */
            text-align: center; /* This centers the content */
            background: #ffffff; /* This makes the background white for high contrast */
            transition: all 0.3s ease; /* This makes changes happen smoothly */
        }

        .file-input-wrapper:hover { /* This styles what happens when you hover over the file picker */
            border-color: var(--primary-color); /* This makes the border darker when you hover */
            background: #f8f8f8; /* This makes the background slightly gray when you hover */
        }

        .file-input { /* This styles the actual file input (the invisible part) */
            display: none; /* This hides the ugly default file input button */
        }

        .file-label { /* This styles our custom "Choose Excel File" button */
            display: inline-block; /* This makes the button behave like a block but stay in line */
            padding: var(--spacing-md) var(--spacing-lg); /* This adds medium spacing above/below and large spacing left/right */
            background: var(--secondary-color); /* This makes the button dark blue */
            color: white; /* This makes the text on the button white */
            border-radius: var(--border-radius); /* This makes the button corners rounded */
            cursor: pointer; /* This makes the mouse cursor change to a hand when you hover over it */
            font-size: 1rem; /* This sets the button text size */
            font-weight: 600; /* This makes the text bold for better visibility */
            transition: all 0.3s ease; /* This makes changes happen smoothly */
            border: none; /* This removes any default border */
            text-decoration: none; /* This removes any underline */
        }

        .file-label:hover { /* This styles what happens when you hover over the button */
            background: var(--primary-color); /* This makes the button darker when you hover */
            transform: translateY(-2px); /* This makes the button move up 2 pixels when you hover (like it's lifting up) */
        }

        .file-info { /* This styles the small text below the button */
            margin-top: var(--spacing-md); /* This adds medium spacing above this text */
            color: var(--text-muted); /* This makes the text dark gray for high contrast */
            font-size: 0.9rem; /* This makes the text slightly smaller than normal */
            line-height: 1.4; /* This makes the text easier to read */
            font-weight: 500; /* This makes the text medium weight for better visibility */
        }

        .search-section { /* This styles the search section */
            margin-bottom: var(--spacing-xl); /* This adds extra large spacing below the search section */
        }

        .search-section h3 { /* This styles the "Search Words" heading */
            margin: 0 0 var(--spacing-md) 0; /* This removes top margin and adds medium spacing below */
            font-size: 1.1rem; /* This makes the heading slightly bigger than normal text */
            color: var(--primary-color); /* This sets the heading color */
        }

        .search-input { /* This styles the search input box */
            width: 100%; /* This makes the search box take up the full width */
            padding: var(--spacing-md); /* This adds medium spacing inside the search box */
            border: 2px solid var(--border-color); /* This creates a more visible border */
            border-radius: var(--border-radius); /* This makes the corners rounded */
            font-size: 1rem; /* This sets the text size */
            color: var(--primary-color); /* This makes the text dark for high contrast */
            background: white; /* This makes the background white */
            transition: border-color 0.3s ease; /* This makes border color changes happen smoothly */
            box-sizing: border-box; /* This includes padding in the width calculation */
        }

        .search-input:focus { /* This styles what happens when you click in the search box */
            outline: none; /* This removes the default outline */
            border-color: var(--secondary-color); /* This makes the border blue when you focus */
        }

        .search-input::placeholder { /* This styles the placeholder text */
            color: var(--text-light); /* This makes the placeholder text medium gray - readable but distinct */
            opacity: 1; /* This ensures the placeholder is fully visible */
        }

        .categories-section { /* This styles the categories section */
            margin-bottom: var(--spacing-xl); /* This adds extra large spacing below the categories section */
        }

        .categories-section h3 { /* This styles the "Categories" heading */
            margin: 0 0 var(--spacing-md) 0; /* This removes top margin and adds medium spacing below */
            font-size: 1.1rem; /* This makes the heading slightly bigger than normal text */
            color: var(--primary-color); /* This sets the heading color */
        }

        .category-controls { /* This styles the select all/none buttons */
            display: flex; /* This makes the buttons sit side by side */
            gap: var(--spacing-sm); /* This adds small spacing between the buttons */
            margin-bottom: var(--spacing-md); /* This adds medium spacing below the buttons */
        }

        .control-btn { /* This styles the select all/none buttons */
            flex: 1; /* This makes each button take up equal space */
            padding: var(--spacing-sm) var(--spacing-md); /* This adds small spacing above/below and medium spacing left/right */
            background: var(--background-color); /* This makes the buttons light gray */
            color: var(--primary-color); /* This makes the text dark */
            border: 2px solid var(--border-color); /* This creates a more visible border */
            border-radius: var(--border-radius); /* This makes the corners rounded */
            cursor: pointer; /* This makes the mouse cursor change to a hand when you hover over it */
            font-size: 0.9rem; /* This makes the text slightly smaller than normal */
            font-weight: 600; /* This makes the text bold for better visibility */
            transition: all 0.3s ease; /* This makes changes happen smoothly */
        }

        .control-btn:hover { /* This styles what happens when you hover over the buttons */
            background: var(--secondary-color); /* This makes the button blue when you hover */
            color: white; /* This makes the text white when you hover */
            border-color: var(--secondary-color); /* This makes the border blue when you hover */
        }

        .category-list { /* This styles the list of categories */
            max-height: 300px; /* This limits the height of the category list */
            overflow-y: auto; /* This adds a scrollbar if there are too many categories */
        }

        .category-item { /* This styles each category item */
            display: flex; /* This makes the checkbox and label sit side by side */
            align-items: center; /* This centers the checkbox and label vertically */
            padding: var(--spacing-sm) 0; /* This adds small spacing above and below */
            border-bottom: 1px solid var(--border-color); /* This adds a light border at the bottom */
        }

        .category-item:last-child { /* This removes the border from the last category */
            border-bottom: none; /* This removes the bottom border */
        }

        .category-checkbox { /* This styles the checkboxes */
            margin-right: var(--spacing-md); /* This adds medium spacing to the right of the checkbox */
            cursor: pointer; /* This makes the mouse cursor change to a hand when you hover over it */
        }

        .category-label { /* This styles the category labels */
            display: flex; /* This makes the color dot and text sit side by side */
            align-items: center; /* This centers the color dot and text vertically */
            cursor: pointer; /* This makes the mouse cursor change to a hand when you hover over it */
            flex: 1; /* This makes the label take up the remaining space */
        }

        .category-color { /* This styles the colored dots next to category names */
            width: 12px; /* This sets the width of the color dot */
            height: 12px; /* This sets the height of the color dot */
            border-radius: 50%; /* This makes the dot perfectly round */
            margin-right: var(--spacing-sm); /* This adds small spacing to the right of the dot */
            border: 1px solid rgba(0,0,0,0.1); /* This adds a subtle border around the dot */
        }

        .category-name { /* This styles the category name text */
            font-size: 0.9rem; /* This makes the text slightly smaller than normal */
            color: var(--primary-color); /* This sets the text color to dark for high contrast */
            word-wrap: break-word; /* This makes long names wrap to the next line */
            font-weight: 500; /* This makes the text medium weight for better visibility */
        }

        .word-count { /* This styles the word count next to each category */
            font-size: 0.8rem; /* This makes the text smaller than normal */
            color: var(--text-muted); /* This makes the text dark gray for high contrast */
            margin-left: auto; /* This pushes the count to the right side */
            font-weight: 500; /* This makes the text medium weight for better visibility */
        }

        .export-section { /* This styles the export section */
            margin-bottom: var(--spacing-xl); /* This adds extra large spacing below the export section */
        }

        .export-section h3 { /* This styles the "Export" heading */
            margin: 0 0 var(--spacing-md) 0; /* This removes top margin and adds medium spacing below */
            font-size: 1.1rem; /* This makes the heading slightly bigger than normal text */
            color: var(--primary-color); /* This sets the heading color */
        }

        .export-btn { /* This styles the export button */
            width: 100%; /* This makes the button take up the full width */
            padding: var(--spacing-md); /* This adds medium spacing inside the button */
            background: var(--success-color); /* This makes the button dark green */
            color: white; /* This makes the text white */
            border: none; /* This removes any border */
            border-radius: var(--border-radius); /* This makes the corners rounded */
            cursor: pointer; /* This makes the mouse cursor change to a hand when you hover over it */
            font-size: 1rem; /* This sets the text size */
            font-weight: 600; /* This makes the text bold for better visibility */
            transition: all 0.3s ease; /* This makes changes happen smoothly */
        }

        .export-btn:hover { /* This styles what happens when you hover over the export button */
            background: #004d00; /* This makes the button darker green when you hover */
            transform: translateY(-2px); /* This makes the button move up 2 pixels when you hover */
        }

        .export-btn:disabled { /* This styles the export button when it's disabled */
            background: var(--text-light); /* This makes the button medium gray when disabled */
            color: white; /* This keeps the text white for contrast */
            cursor: not-allowed; /* This shows a "not allowed" cursor when disabled */
            transform: none; /* This removes any transform when disabled */
        }

        .help-section { /* This styles the help section */
            margin-bottom: var(--spacing-xl); /* This adds extra large spacing below the help section */
        }

        .help-section h3 { /* This styles the "Help" heading */
            margin: 0 0 var(--spacing-md) 0; /* This removes top margin and adds medium spacing below */
            font-size: 1.1rem; /* This makes the heading slightly bigger than normal text */
            color: var(--primary-color); /* This sets the heading color */
        }

        .help-content { /* This styles the help content */
            font-size: 0.9rem; /* This makes the text slightly smaller than normal */
            color: var(--text-muted); /* This makes the text dark gray for high contrast */
            line-height: 1.5; /* This makes the text easier to read */
        }

        .help-content h4 { /* This styles the help subheadings */
            margin: var(--spacing-md) 0 var(--spacing-sm) 0; /* This adds spacing around subheadings */
            color: var(--primary-color); /* This sets the subheading color to dark */
            font-size: 1rem; /* This makes the subheadings normal size */
            font-weight: 600; /* This makes the subheadings bold for better visibility */
        }

        .help-content ul { /* This styles the help lists */
            margin: var(--spacing-sm) 0; /* This adds small spacing around lists */
            padding-left: var(--spacing-lg); /* This indents the list items */
        }

        .help-content li { /* This styles the help list items */
            margin-bottom: var(--spacing-sm); /* This adds small spacing below each list item */
            color: var(--text-muted); /* This makes the list items dark gray for high contrast */
            font-weight: 500; /* This makes the list items medium weight for better visibility */
        }

        .word-cloud-container { /* This styles the big area where the word cloud appears */
            width: 100%; /* This makes the container take up the full width */
            height: 100%; /* This makes the container take up the full height */
            position: relative; /* This allows us to position things inside this area */
            min-height: 500px; /* This ensures the area is at least 500 pixels tall */
        }

        .loading { /* This styles the "loading" text that appears while the file is being read */
            text-align: center; /* This centers the loading text */
            color: var(--text-muted); /* This makes the text gray */
            font-size: 1.2rem; /* This makes the text slightly bigger than normal */
            margin-top: 200px; /* This adds 200 pixels of space above the text */
        }

        .tooltip { /* This styles the little box that appears when you hover over a word */
            position: absolute; /* This allows us to position it anywhere on the page */
            background: rgba(0, 0, 0, 0.95); /* This makes the background dark black with some transparency */
            color: white; /* This makes the text white */
            padding: var(--spacing-md); /* This adds medium spacing inside the tooltip */
            border-radius: var(--border-radius); /* This makes the corners rounded */
            font-size: 14px; /* This sets the text size to 14 pixels */
            max-width: 300px; /* This makes sure the tooltip is never wider than 300 pixels */
            z-index: 1000; /* This makes sure the tooltip appears on top of everything else */
            pointer-events: none; /* This makes sure the tooltip doesn't interfere with mouse clicks */
            box-shadow: var(--shadow); /* This creates a shadow around the tooltip */
            opacity: 0; /* This makes the tooltip invisible initially */
            transition: opacity 0.15s ease; /* This makes the tooltip appear/disappear smoothly */
        }

        .tooltip.show { /* This styles the tooltip when it's visible */
            opacity: 1; /* This makes the tooltip fully visible */
        }

        .tooltip::after { /* This creates a little arrow pointing down from the tooltip */
            content: ''; /* This creates an empty element */
            position: absolute; /* This allows us to position it */
            top: 100%; /* This positions it at the bottom of the tooltip */
            left: 50%; /* This centers it horizontally */
            margin-left: -5px; /* This adjusts the position to center it perfectly */
            border-width: 5px; /* This sets the size of the arrow */
            border-style: solid; /* This makes the arrow solid */
            border-color: rgba(0, 0, 0, 0.95) transparent transparent transparent; /* This creates a black arrow pointing down */
        }

        .word { /* This styles each individual word in the word cloud */
            cursor: pointer; /* This makes the mouse cursor change to a hand when you hover over words */
            transition: all 0.2s ease; /* This makes changes happen smoothly over 0.2 seconds */
        }

        .word:hover { /* This styles what happens when you hover over a word */
            transform: scale(1.1); /* This makes the word get 10% bigger when you hover */
        }

        .word.hidden { /* This styles words that are hidden by filters */
            opacity: 0; /* This makes hidden words invisible */
            pointer-events: none; /* This makes hidden words unclickable */
        }

        .error { /* This styles error messages that appear if something goes wrong */
            color: var(--danger-color); /* This makes the text red */
            text-align: center; /* This centers the error text */
            padding: var(--spacing-lg); /* This adds large spacing around the text */
            background: #fdf2f2; /* This makes the background light red */
            border: 1px solid #fecaca; /* This creates a light red border */
            border-radius: var(--border-radius); /* This makes the corners rounded */
            margin: var(--spacing-lg) 0; /* This adds large spacing above and below */
        }

        .stats { /* This styles the statistics text at the bottom */
            text-align: center; /* This centers the stats text */
            margin-top: var(--spacing-lg); /* This adds large spacing above the stats */
            color: var(--text-muted); /* This makes the text gray */
            font-size: 0.9rem; /* This makes the text slightly smaller than normal */
        }

        /* Responsive Design - This makes the page work well on phones and tablets */
        @media (max-width: 768px) { /* This applies styles when the screen is smaller than 768 pixels (phones) */
            .main-container { /* This changes the layout for mobile devices */
                flex-direction: column; /* This stacks the side panel above the main area */
                padding: var(--spacing-md); /* This reduces padding on mobile */
            }

            .side-panel { /* This styles the side panel on mobile */
                width: 100%; /* This makes the side panel take up the full width */
                margin-bottom: var(--spacing-lg); /* This adds large spacing below the side panel */
            }

            .header h1 { /* This styles the title on mobile */
                font-size: 1.5rem; /* This makes the title smaller on mobile */
            }

            .category-controls { /* This styles the control buttons on mobile */
                flex-direction: column; /* This stacks the buttons vertically on mobile */
            }
        }

        @media (max-width: 480px) { /* This applies styles when the screen is smaller than 480 pixels (very small phones) */
            .main-container { /* This further adjusts the layout for very small screens */
                padding: var(--spacing-sm); /* This reduces padding even more */
                gap: var(--spacing-md); /* This reduces the gap between sections */
            }

            .header { /* This styles the header on very small screens */
                padding: var(--spacing-md); /* This reduces header padding */
            }

            .side-panel, .main-area { /* This styles both panels on very small screens */
                padding: var(--spacing-md); /* This reduces padding in both panels */
            }
        }
    </style> <!-- This ends the CSS section -->
</head> <!-- This ends the head section -->
<body> <!-- This starts the body section where all the visible content goes -->
    <div class="header"> <!-- This creates the header section at the top -->
        <h1>Technical Jargon: Word Cloud</h1> <!-- This is the main title -->
    </div>

    <div class="main-container"> <!-- This creates the main layout container -->
        <div class="side-panel"> <!-- This creates the left side panel with controls -->
            <div class="file-picker-section"> <!-- This creates the file picker area -->
                <h3>File Input</h3> <!-- This is the heading for the file picker -->
                <div class="file-input-wrapper"> <!-- This creates the file picker area -->
                    <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv"> <!-- This is the invisible file input that actually lets you choose files -->
                    <label for="fileInput" class="file-label"> <!-- This creates our custom blue button that you can see -->
                        üìÅ Choose Excel File <!-- This is the text that appears on the button -->
                    </label>
                    <div class="file-info"> <!-- This creates the small gray text below the button -->
                        Select an Excel file (.xlsx, .xls) or CSV file<br> <!-- This tells you what types of files you can choose -->
                        First column = Word, Second column = Definition <!-- This tells you how your file should be organized -->
                    </div>
                </div>
            </div>

            <div class="search-section"> <!-- This creates the search section -->
                <h3>Search Words</h3> <!-- This is the heading for the search -->
                <input type="text" id="searchInput" class="search-input" placeholder="Type to filter words..." aria-label="Search words in the word cloud"> <!-- This creates the search input box -->
            </div>

            <div class="categories-section"> <!-- This creates the categories section -->
                <h3>Categories</h3> <!-- This is the heading for the categories -->
                <div class="category-controls"> <!-- This creates the select all/none buttons -->
                    <button class="control-btn" id="selectAllBtn" aria-label="Select all categories">Select All</button> <!-- This creates the "Select All" button -->
                    <button class="control-btn" id="selectNoneBtn" aria-label="Deselect all categories">Select None</button> <!-- This creates the "Select None" button -->
                </div>
                <div id="categoryList" class="category-list"> <!-- This creates the list of categories -->
                    <!-- Categories will be added here by JavaScript -->
                </div>
            </div>

            <div class="export-section"> <!-- This creates the export section -->
                <h3>Export</h3> <!-- This is the heading for the export -->
                <button class="export-btn" id="exportBtn" disabled aria-label="Export word cloud as image">üì∏ Save as Image</button> <!-- This creates the export button -->
            </div>

            <div class="help-section"> <!-- This creates the help section -->
                <h3>Help</h3> <!-- This is the heading for the help -->
                <div class="help-content"> <!-- This creates the help content -->
                    <h4>How to use:</h4> <!-- This is a subheading -->
                    <ul> <!-- This creates a list -->
                        <li>Choose an Excel file with words and definitions</li> <!-- This is a list item -->
                        <li>Each sheet becomes a category with its own color</li> <!-- This is a list item -->
                        <li>Use checkboxes to show/hide categories</li> <!-- This is a list item -->
                        <li>Type in search to filter words</li> <!-- This is a list item -->
                        <li>Hover over words to see definitions</li> <!-- This is a list item -->
                        <li>Export your cloud as an image</li> <!-- This is a list item -->
                    </ul>
                    <h4>File format:</h4> <!-- This is a subheading -->
                    <ul> <!-- This creates a list -->
                        <li>First column: Word or term</li> <!-- This is a list item -->
                        <li>Second column: Definition or explanation</li> <!-- This is a list item -->
                        <li>Each sheet = one category</li> <!-- This is a list item -->
                    </ul>
                </div>
            </div>
        </div>

        <div class="main-area"> <!-- This creates the main area where the word cloud appears -->
            <div id="wordCloudContainer" class="word-cloud-container"> <!-- This creates the big area where the word cloud will appear -->
                <div class="loading">Choose a file to generate your word cloud</div> <!-- This shows the initial message before you choose a file -->
            </div>
            <div id="stats" class="stats"></div> <!-- This creates the area where statistics will be shown at the bottom -->
        </div>
    </div>

    <script> <!-- This starts the JavaScript section where all the interactive code goes -->
        // Global variables (these are like containers that hold information that the whole program can use)
        let allWordData = []; // This holds all the words and definitions from all sheets
        let filteredWordData = []; // This holds the words that are currently visible after filtering
        let categories = new Map(); // This holds information about each category (sheet)
        let tooltip = null; // This will hold the little popup box that shows definitions when you hover over words
        let searchTimeout = null; // This holds the timeout for search debouncing
        let currentSvg = null; // This holds the current SVG element for export

        // Category colors - distinct, readable colors with good contrast
        const categoryColors = [
            "#e74c3c", "#3498db", "#2ecc71", "#f39c12", 
            "#9b59b6", "#1abc9c", "#34495e", "#e67e22",
            "#95a5a6", "#f1c40f", "#8e44ad", "#16a085",
            "#d35400", "#27ae60", "#2980b9", "#8e44ad"
        ];

        // State management - this saves and restores user choices
        const state = {
            searchTerm: '', // This holds the current search term
            categoryVisibility: new Map(), // This holds which categories are visible
            saveState: function() { // This function saves the current state
                const stateData = { // This creates an object with the current state
                    searchTerm: this.searchTerm, // This saves the search term
                    categoryVisibility: Object.fromEntries(this.categoryVisibility) // This saves the category visibility
                };
                localStorage.setItem('wordCloudState', JSON.stringify(stateData)); // This saves the state to browser storage
            },
            loadState: function() { // This function loads the saved state
                try { // This starts a try-catch block to handle any errors
                    const savedState = localStorage.getItem('wordCloudState'); // This gets the saved state from browser storage
                    if (savedState) { // This checks if there's a saved state
                        const stateData = JSON.parse(savedState); // This converts the saved state back to an object
                        this.searchTerm = stateData.searchTerm || ''; // This restores the search term
                        this.categoryVisibility = new Map(Object.entries(stateData.categoryVisibility || {})); // This restores the category visibility
                    }
                } catch (error) { // This catches any errors that might happen
                    console.log('No saved state found or error loading state'); // This logs a message if there's no saved state
                }
            },
            restoreState: function() { // This function restores the saved state to the UI
                // Restore search term
                const searchInput = document.getElementById('searchInput'); // This finds the search input
                if (searchInput) { // This checks if the search input exists
                    searchInput.value = this.searchTerm; // This sets the search input to the saved value
                }

                // Restore category visibility
                this.categoryVisibility.forEach((visible, categoryName) => { // This goes through each saved category visibility
                    if (categories.has(categoryName)) { // This checks if the category still exists
                        categories.get(categoryName).visible = visible; // This restores the visibility
                    }
                });
            }
        };

        // Initialize tooltip (this function sets up the little popup box that shows definitions)
        function initTooltip() {
            tooltip = d3.select("body") // This finds the body of the webpage
                .append("div") // This creates a new div (box) element
                .attr("class", "tooltip") // This gives the div the CSS class "tooltip" so it gets styled properly
                .style("opacity", 0); // This makes the tooltip invisible initially
        }

        // Show tooltip on hover (this function makes the definition popup appear when you hover over a word)
        function showTooltip(event, d) {
            if (!d.visible) return; // This prevents showing tooltips for hidden words

            const tooltipElement = tooltip.node(); // This gets the actual HTML element
            tooltipElement.classList.add('show'); // This makes the tooltip visible

            // Calculate position to keep tooltip on screen
            const tooltipWidth = 300; // This sets the maximum width of the tooltip
            const tooltipHeight = 100; // This estimates the height of the tooltip
            const margin = 10; // This adds a margin from the screen edge

            let left = event.pageX + 10; // This positions the tooltip 10 pixels to the right of your mouse
            let top = event.pageY - 10; // This positions the tooltip 10 pixels above your mouse

            // Adjust if tooltip would go off the right edge
            if (left + tooltipWidth > window.innerWidth - margin) {
                left = event.pageX - tooltipWidth - 10; // This moves the tooltip to the left of the mouse
            }

            // Adjust if tooltip would go off the bottom edge
            if (top + tooltipHeight > window.innerHeight - margin) {
                top = event.pageY - tooltipHeight - 10; // This moves the tooltip above the mouse
            }

            // Adjust if tooltip would go off the top edge
            if (top < margin) {
                top = margin; // This keeps the tooltip at least 10 pixels from the top
            }

            tooltip.html(`<strong>${d.word}</strong><br/><em>${d.category}</em><br/>${d.definition}`) // This puts the word, category, and definition into the tooltip box
                .style("left", left + "px") // This sets the X position
                .style("top", top + "px"); // This sets the Y position
        }

        // Hide tooltip (this function makes the definition popup disappear when you move your mouse away)
        function hideTooltip() {
            if (tooltip) { // This checks if the tooltip exists
                tooltip.node().classList.remove('show'); // This makes the tooltip invisible
            }
        }

        // Filter words based on search and category visibility
        function filterWords() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim(); // This gets the search term and makes it lowercase
            const visibleCategories = Array.from(categories.keys()).filter(cat => categories.get(cat).visible); // This gets all visible categories

            filteredWordData = allWordData.filter(word => { // This filters the words based on search and category
                const matchesSearch = !searchTerm || word.word.toLowerCase().includes(searchTerm); // This checks if the word matches the search term
                const matchesCategory = visibleCategories.includes(word.category); // This checks if the word's category is visible
                return matchesSearch && matchesCategory; // This returns true only if both conditions are met
            });

            // Save search term to state
            state.searchTerm = searchTerm; // This saves the search term to the state
            state.saveState(); // This saves the state

            updateWordCloud(); // This updates the word cloud with the filtered words
        }

        // Update word cloud visibility
        function updateWordCloud() {
            const svg = d3.select("#wordCloudContainer svg"); // This finds the SVG element
            if (svg.empty()) return; // This stops if there's no SVG

            const textElements = svg.selectAll("text.word"); // This finds all word elements

            textElements.each(function(d) { // This goes through each word
                const word = d3.select(this); // This selects the current word element
                const isVisible = filteredWordData.some(w => w.word === d.word && w.category === d.category); // This checks if this word should be visible
                
                if (isVisible) { // This shows the word if it should be visible
                    word.classed('hidden', false); // This removes the hidden class
                    d.visible = true; // This marks the word as visible
                } else { // This hides the word if it shouldn't be visible
                    word.classed('hidden', true); // This adds the hidden class
                    d.visible = false; // This marks the word as not visible
                }
            });

            // Update statistics
            const visibleWords = filteredWordData.length; // This counts the visible words
            const totalWords = allWordData.length; // This counts the total words
            document.getElementById("stats").innerHTML = 
                `Showing ${visibleWords} of ${totalWords} words`; // This updates the statistics
        }

        // Export word cloud as image
        function exportWordCloud() {
            if (!currentSvg) { // This checks if there's no SVG to export
                alert('No word cloud to export. Please load a file first.'); // This shows an alert
                return; // This stops the function
            }

            try { // This starts a try-catch block to handle any errors
                const svgElement = currentSvg.node(); // This gets the actual SVG element
                const svgData = new XMLSerializer().serializeToString(svgElement); // This converts the SVG to a string
                const canvas = document.createElement('canvas'); // This creates a canvas element
                const ctx = canvas.getContext('2d'); // This gets the canvas context
                const img = new Image(); // This creates an image element

                // Set canvas size to match SVG
                canvas.width = 800; // This sets the canvas width
                canvas.height = 500; // This sets the canvas height

                img.onload = function() { // This function runs when the image has loaded
                    ctx.fillStyle = 'white'; // This sets the background color to white
                    ctx.fillRect(0, 0, canvas.width, canvas.height); // This fills the canvas with white
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height); // This draws the image on the canvas

                    // Create download link
                    const link = document.createElement('a'); // This creates a download link
                    link.download = 'word-cloud.png'; // This sets the filename
                    link.href = canvas.toDataURL('image/png'); // This creates the image data URL
                    link.click(); // This triggers the download
                };

                img.src = 'data:image/svg+xml;base64,' + btoa(svgData); // This sets the image source to the SVG data
            } catch (error) { // This catches any errors that might happen
                console.error('Export failed:', error); // This logs the error
                alert('Failed to export image. Please try again.'); // This shows an error message
            }
        }

        // Generate word cloud (this is the main function that creates the pretty word cloud from your data)
        function generateWordCloud(data) {
            const container = d3.select("#wordCloudContainer"); // This finds the big area where the word cloud will appear
            container.selectAll("*").remove(); // This clears out any old word cloud that might be there

            if (data.length === 0) { // This checks if there's no data to work with
                container.html('<div class="error">No data found. Please check your file format.</div>'); // This shows an error message
                document.getElementById('exportBtn').disabled = true; // This disables the export button
                return; // This stops the function here if there's no data
            }

            // Create SVG (this creates the canvas where we'll draw the word cloud)
            const svg = container
                .append("svg") // This creates an SVG element (like a digital canvas for drawing)
                .attr("width", "100%") // This makes the canvas take up the full width of its container
                .attr("height", 500) // This makes the canvas 500 pixels tall
                .style("background", "white"); // This makes the background white

            currentSvg = svg; // This saves the SVG for export
            document.getElementById('exportBtn').disabled = false; // This enables the export button

            // Calculate word frequencies and sizes (this counts how many times each word appears)
            const wordCounts = {}; // This creates an empty object to store word counts
            data.forEach(item => { // This goes through each word and definition from your Excel file
                const word = item.word.toLowerCase().trim(); // This makes the word lowercase and removes extra spaces
                if (word && word.length > 0) { // This checks if the word exists and isn't empty
                    const key = `${word}_${item.category}`; // This creates a unique key for each word-category combination
                    if (!wordCounts[key]) { // This checks if we haven't seen this word-category combination before
                        wordCounts[key] = { // This creates a new entry for this word-category combination
                            word: word,
                            category: item.category,
                            count: 0,
                            definition: item.definition
                        };
                    }
                    wordCounts[key].count++; // This increases the count for this word-category combination
                }
            });

            // Convert to array and sort by frequency (this organizes the words by how often they appear)
            const words = Object.values(wordCounts).sort((a, b) => b.count - a.count); // This sorts the words so the most frequent ones come first

            // Set up scales (this determines how big each word should be)
            const maxCount = Math.max(...words.map(d => d.count)); // This finds the highest word count
            const minCount = Math.min(...words.map(d => d.count)); // This finds the lowest word count
            
            const fontSizeScale = d3.scaleLinear() // This creates a scale for font sizes
                .domain([minCount, maxCount]) // This sets the input range (from lowest to highest count)
                .range([12, 36]); // This sets the output range (from 12 pixels to 36 pixels font size)

            // Create word elements (this creates the actual text elements for each word)
            const textElements = svg.selectAll("text") // This finds all text elements (there are none yet)
                .data(words) // This connects each word to a text element
                .enter() // This creates a new text element for each word
                .append("text") // This adds the text element to the SVG
                .attr("class", "word") // This gives each text element the CSS class "word"
                .text(d => d.word) // This sets the text content to be the actual word
                .style("font-size", d => fontSizeScale(d.count) + "px") // This sets the font size based on how often the word appears
                .style("fill", d => categories.get(d.category)?.color || "#000000") // This sets the color based on the category
                .style("font-family", "Arial, sans-serif") // This sets the font type
                .style("font-weight", "bold") // This makes the text bold
                .style("text-anchor", "middle") // This centers the text horizontally
                .on("mouseover", showTooltip) // This makes the tooltip appear when you hover over the word
                .on("mouseout", hideTooltip); // This makes the tooltip disappear when you move your mouse away

            // Simple word cloud layout (circular arrangement) - this positions each word in a circle
            const centerX = 200; // This is the X coordinate of the center of the circle
            const centerY = 250; // This is the Y coordinate of the center of the circle
            const radius = 150; // This is the radius (distance from center) of the circle

            textElements.each(function(d, i) { // This goes through each word and positions it
                const angle = (i / words.length) * 2 * Math.PI; // This calculates the angle for this word (in radians)
                const r = radius * (0.3 + 0.7 * Math.random()); // This calculates a random distance from center (between 30% and 100% of radius)
                const x = centerX + r * Math.cos(angle); // This calculates the X position using trigonometry
                const y = centerY + r * Math.sin(angle); // This calculates the Y position using trigonometry
                
                d3.select(this) // This selects the current word
                    .attr("x", x) // This sets the X position
                    .attr("y", y); // This sets the Y position
            });

            // Update statistics
            document.getElementById("stats").innerHTML = 
                `Generated word cloud with ${words.length} unique words from ${data.length} total entries`; // This shows how many words were processed
        }

        // Create category legend
        function createCategoryLegend() {
            const categoryList = document.getElementById('categoryList'); // This finds the category list element
            categoryList.innerHTML = ''; // This clears any existing categories

            categories.forEach((categoryData, categoryName) => { // This goes through each category
                const categoryItem = document.createElement('div'); // This creates a new div for the category
                categoryItem.className = 'category-item'; // This gives it the category-item class

                const checkbox = document.createElement('input'); // This creates a checkbox
                checkbox.type = 'checkbox'; // This makes it a checkbox
                checkbox.className = 'category-checkbox'; // This gives it the category-checkbox class
                checkbox.checked = categoryData.visible; // This sets whether it's checked based on visibility
                checkbox.id = `category-${categoryName}`; // This gives it a unique ID

                const label = document.createElement('label'); // This creates a label
                label.className = 'category-label'; // This gives it the category-label class
                label.htmlFor = checkbox.id; // This connects the label to the checkbox

                const colorDot = document.createElement('div'); // This creates the colored dot
                colorDot.className = 'category-color'; // This gives it the category-color class
                colorDot.style.backgroundColor = categoryData.color; // This sets the color

                const nameSpan = document.createElement('span'); // This creates a span for the name
                nameSpan.className = 'category-name'; // This gives it the category-name class
                nameSpan.textContent = categoryName; // This sets the text to the category name

                const countSpan = document.createElement('span'); // This creates a span for the count
                countSpan.className = 'word-count'; // This gives it the word-count class
                countSpan.textContent = `(${categoryData.count})`; // This shows the word count

                label.appendChild(colorDot); // This adds the color dot to the label
                label.appendChild(nameSpan); // This adds the name to the label
                label.appendChild(countSpan); // This adds the count to the label

                categoryItem.appendChild(checkbox); // This adds the checkbox to the item
                categoryItem.appendChild(label); // This adds the label to the item

                // Add event listener for checkbox changes
                checkbox.addEventListener('change', function() { // This listens for when the checkbox is clicked
                    categories.get(categoryName).visible = this.checked; // This updates the category visibility
                    state.categoryVisibility.set(categoryName, this.checked); // This saves the visibility to state
                    state.saveState(); // This saves the state
                    filterWords(); // This filters the words based on the new visibility
                });

                categoryList.appendChild(categoryItem); // This adds the category item to the list
            });
        }

        // Set up category controls
        function setupCategoryControls() {
            document.getElementById('selectAllBtn').addEventListener('click', function() { // This listens for clicks on "Select All"
                categories.forEach((categoryData, categoryName) => { // This goes through each category
                    categoryData.visible = true; // This makes all categories visible
                    state.categoryVisibility.set(categoryName, true); // This saves the visibility to state
                });
                state.saveState(); // This saves the state
                createCategoryLegend(); // This updates the legend
                filterWords(); // This filters the words
            });

            document.getElementById('selectNoneBtn').addEventListener('click', function() { // This listens for clicks on "Select None"
                categories.forEach((categoryData, categoryName) => { // This goes through each category
                    categoryData.visible = false; // This makes all categories invisible
                    state.categoryVisibility.set(categoryName, false); // This saves the visibility to state
                });
                state.saveState(); // This saves the state
                createCategoryLegend(); // This updates the legend
                filterWords(); // This filters the words
            });
        }

        // Set up search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput'); // This finds the search input
            searchInput.addEventListener('input', function() { // This listens for typing in the search box
                clearTimeout(searchTimeout); // This clears any existing timeout
                searchTimeout = setTimeout(() => { // This creates a new timeout
                    filterWords(); // This filters the words after the user stops typing
                }, 300); // This waits 300 milliseconds after the user stops typing
            });
        }

        // Set up export functionality
        function setupExport() {
            document.getElementById('exportBtn').addEventListener('click', exportWordCloud); // This listens for clicks on the export button
        }

        // Read Excel file (this function reads the Excel file you choose and extracts the words and definitions from all sheets)
        function readExcelFile(file) {
            const reader = new FileReader(); // This creates a file reader object that can read files
            
            reader.onload = function(e) { // This function runs when the file has been read
                try { // This starts a try-catch block to handle any errors
                    const data = new Uint8Array(e.target.result); // This converts the file data into a format we can work with
                    const workbook = XLSX.read(data, { type: 'array' }); // This reads the Excel file using the XLSX library
                    
                    allWordData = []; // This clears any existing data
                    categories.clear(); // This clears any existing categories
                    state.categoryVisibility.clear(); // This clears any existing category visibility state

                    // Process all sheets (this goes through every sheet in the Excel file)
                    workbook.SheetNames.forEach((sheetName, index) => { // This goes through each sheet name
                        const worksheet = workbook.Sheets[sheetName]; // This gets the data from the current sheet
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // This converts the sheet to a JSON array
                        
                        // Process data from this sheet (this cleans up the data and makes sure it has the right format)
                        const sheetData = jsonData
                            .filter(row => row.length >= 2 && row[0] && row[1]) // This removes any rows that don't have at least 2 columns with data
                            .map(row => ({ // This converts each row into an object with word, definition, and category
                                word: String(row[0]).trim(), // This gets the first column (word) and removes extra spaces
                                definition: String(row[1]).trim(), // This gets the second column (definition) and removes extra spaces
                                category: sheetName // This sets the category to the sheet name
                            }));

                        allWordData = allWordData.concat(sheetData); // This adds the sheet data to all the data

                        // Set up category information
                        categories.set(sheetName, { // This creates a new category entry
                            visible: true, // This makes the category visible by default
                            color: categoryColors[index % categoryColors.length], // This assigns a color to the category
                            count: sheetData.length // This counts how many words are in this category
                        });
                    });

                    filteredWordData = [...allWordData]; // This makes all words visible initially
                    generateWordCloud(allWordData); // This calls the function to create the word cloud
                    createCategoryLegend(); // This creates the category legend
                    
                    // Restore saved state after loading new data
                    state.restoreState(); // This restores the saved state
                    createCategoryLegend(); // This updates the legend with restored state
                    filterWords(); // This applies the restored filters
                    
                } catch (error) { // This catches any errors that might happen
                    console.error("Error reading file:", error); // This logs the error to the browser console
                    document.getElementById("wordCloudContainer").innerHTML = 
                        '<div class="error">Error reading file. Please make sure it\'s a valid Excel file.</div>'; // This shows an error message to the user
                    document.getElementById('exportBtn').disabled = true; // This disables the export button
                }
            };
            
            reader.readAsArrayBuffer(file); // This starts reading the file as binary data
        }

        // File input change handler (this function runs when you choose a file)
        document.getElementById("fileInput").addEventListener("change", function(e) { // This listens for when you choose a file
            const file = e.target.files[0]; // This gets the file you chose
            if (file) { // This checks if you actually chose a file
                document.getElementById("wordCloudContainer").innerHTML = 
                    '<div class="loading">Reading file and generating word cloud...</div>'; // This shows a loading message
                readExcelFile(file); // This calls the function to read the file
            }
        });

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', function() { // This runs when the page has finished loading
            initTooltip(); // This sets up the tooltip system
            setupCategoryControls(); // This sets up the category control buttons
            setupSearch(); // This sets up the search functionality
            setupExport(); // This sets up the export functionality
            state.loadState(); // This loads any saved state
        });
    </script> <!-- This ends the JavaScript section -->
</body> <!-- This ends the body section -->
</html> <!-- This ends the HTML document -->